var gdjs;(function(c){const a=new c.Logger("Player Authentication"),l=c.playerAuthenticationComponents;let Q;(function(r){let b=null,A=null,v=null,M=!1,E=!1,W=null,u=null,T=null,y=null,j=null,p=null,d=null,O=null,P=null,m=null,g=null;c.registerRuntimeScenePostEventsCallback(()=>{M=!1}),c.registerFirstRuntimeSceneLoadedCallback(e=>{$(e)==="web"&&(L(),m=t=>{U({runtimeScene:e,event:t,checkOrigin:!0})},window.addEventListener("message",m,!0),a.info("Notifying parent window that player authentication is ready."),window.parent.postMessage({id:"playerAuthReady"},"*"),O=setTimeout(()=>{a.info("Removing initial authentication listener."),L()},3e3))});const _=e=>`${e}_authenticatedUser`,R=({runtimeGame:e,gameId:t,connectionId:n})=>`https://gd.games/auth?gameId=${t}${n?`&connectionId=${n}`:""}${e.isUsingGDevelopDevelopmentEnvironment()?"&dev=true":""}`,$=e=>e.getGame().getRenderer().getElectron()?"electron":V(e)?"web-iframe":typeof cordova!="undefined"?cordova.platformId==="ios"?"cordova-websocket":"cordova":"web",V=e=>{const t=e.getGame().getAdditionalOptions();return t&&t.isPreview&&t.allowAuthenticationUsingIframeForPreview};r.isAuthenticated=()=>(E||D(),v!==null),r.hasLoggedIn=()=>M,r.getUsername=()=>(E||D(),b||""),r.getUserToken=()=>(E||D(),v||null),r.getUserId=()=>(E||D(),A||"");const N=(e,t,n=0)=>{const i=`${e.isUsingGDevelopDevelopmentEnvironment()?"https://api-dev.gdevelop.io":"https://api.gdevelop.io"}/game/public-game/${t}`;return fetch(i,{method:"HEAD"}).then(s=>s.status!==200?(a.warn(`Error while fetching the game: ${s.status} ${s.statusText}`),s.status===404||n>2?!1:N(e,t,n+1)):!0,s=>(a.error("Error while fetching game:",s),!1))};r.logout=e=>{b=null,v=null,A=null;const t=c.projectData.properties.projectUuid;if(!t){a.error("Missing game id in project properties.");return}window.localStorage.removeItem(_(t)),G(e),r.removeAuthenticationBanner(e);const n=e.getGame().getRenderer().getDomElementContainer();if(!n){w(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}l.displayLoggedOutNotification(n)};const D=()=>{const e=c.projectData.properties.projectUuid;if(!e){a.error("Missing game id in project properties.");return}try{const t=window.localStorage.getItem(_(e));if(!t){E=!0;return}const n=JSON.parse(t);b=n.username,A=n.userId,v=n.userToken,E=!0}catch(t){a.warn("Unable to read authentication details from localStorage. Player authentication will not be available.",t)}},G=e=>{r.removeAuthenticationContainer(e),J(),g&&(a.info("Closing authentication websocket connection."),g.close(),g=null),W&&(W.close(),W=null),u&&(u.close(),u=null)},B=({username:e,userId:t,userToken:n})=>{e||a.warn("The authenticated player does not have a username"),b=e,A=t,v=n,M=!0;const o=c.projectData.properties.projectUuid;if(!o){a.error("Missing game id in project properties.");return}try{window.localStorage.setItem(_(o),JSON.stringify({username:b,userId:A,userToken:v}))}catch(i){a.warn("Unable to save the authentication details to localStorage. Player authentication will not be available.",i)}};r.login=({runtimeScene:e,userId:t,username:n,userToken:o})=>{B({userId:t,username:n,userToken:o}),G(e),r.removeAuthenticationBanner(e);const i=e.getGame().getRenderer().getDomElementContainer();if(!i){w(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}l.displayLoggedInNotification(i,b||"Anonymous")};const U=function({runtimeScene:e,event:t,checkOrigin:n,onDone:o}){if(!(n&&!["https://liluo.io","https://gd.games"].includes(t.origin))){if(!t.data.id)throw new Error("Malformed message");switch(t.data.id){case"authenticationResult":{if(!(t.data.body&&t.data.body.token))throw new Error("Malformed message.");r.login({runtimeScene:e,userId:t.data.body.userId,username:t.data.body.username,userToken:t.data.body.token}),x(e),o&&o("logged");break}case"alreadyAuthenticated":{if(!(t.data.body&&t.data.body.token))throw new Error("Malformed message.");B({userId:t.data.body.userId,username:t.data.body.username,userToken:t.data.body.token}),L(),Z(e);break}}}},w=function(e,t){a.error(t),G(e);const n=e.getGame().getRenderer().getDomElementContainer();if(!n){w(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}l.displayErrorNotification(n),x(e)},X=e=>{J();const t=15*60*1e3;P=setTimeout(()=>{a.info("Authentication window did not send message in time. Closing it."),G(e),x(e)},t)},J=()=>{O&&clearTimeout(O),P&&clearTimeout(P)},K=function(e){const t=()=>{r.removeAuthenticationBanner(e)},n=()=>{r.openAuthenticationWindow(e)};return v?l.computeAuthenticatedBanner(n,t,b):l.computeNotAuthenticatedBanner(n,t)};r.displayAuthenticationBanner=function(e){if(d){d.style.opacity="1";return}E||D();const t=e.getGame().getRenderer().getDomElementContainer();if(!t){w(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}d=K(e),t.appendChild(d)};const Z=function(e){if(!d)return;const t=e.getGame().getRenderer().getDomElementContainer();if(!t){w(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}const n=d;d=K(e),t.replaceChild(d,n)},q=(e,t,n)=>new Promise(o=>{let i=!1;const s=e.getGame().isUsingGDevelopDevelopmentEnvironment()?`wss://api-ws-dev.gdevelop.io/play?gameId=${t}&connectionType=login`:`wss://api-ws.gdevelop.io/play?gameId=${t}&connectionType=login`;g=new WebSocket(s),g.onopen=()=>{a.info("Opened authentication websocket connection."),g&&g.send(JSON.stringify({action:"getConnectionId"}))},g.onerror=()=>{a.info("Error in authentication websocket connection."),i||(i=!0,o("errored")),w(e,"Error while connecting to the authentication server.")},g.onclose=()=>{a.info("Closing authentication websocket connection."),i||(i=!0,o("dismissed"))},g.onmessage=h=>{if(h.data){const k=JSON.parse(h.data);switch(k.type){case"authenticationResult":{const f=k.data;r.login({runtimeScene:e,userId:f.userId,username:f.username,userToken:f.token}),x(e),i=!0,o("logged");break}case"connectionId":{const I=k.data.connectionId;if(!I){a.error("No WebSocket connectionId received"),i=!0,o("errored");return}a.info("WebSocket connectionId received."),n({connectionId:I,resolve:o});break}}}}}),ee=(e,t)=>q(e,t,({connectionId:n})=>{const o=R({runtimeGame:e.getGame(),gameId:t,connectionId:n}),i=e.getGame().getRenderer().getElectron(),s=()=>i.shell.openExternal(o);s(),p&&l.addAuthenticationUrlToTextsContainer(s,p)}),te=(e,t)=>q(e,t,({connectionId:n,resolve:o})=>{const i=R({runtimeGame:e.getGame(),gameId:t,connectionId:n});if(u=cordova.InAppBrowser.open(i,"authentication","location=yes,toolbarcolor=#000000,hidenavigationbuttons=yes,closebuttoncolor=#FFFFFF"),!u){o("errored");return}u.addEventListener("exit",()=>{o("dismissed")},!0)}),ne=(e,t)=>new Promise(n=>{const o=R({runtimeGame:e.getGame(),gameId:t});if(u=cordova.InAppBrowser.open(o,"authentication","location=yes,toolbarcolor=#000000,hidenavigationbuttons=yes,closebuttoncolor=#FFFFFF"),!u){n("errored");return}let i=!1;u.addEventListener("message",s=>{U({runtimeScene:e,event:s,checkOrigin:!1,onDone:h=>{i||(i=!0,n(h))}})},!0),u.addEventListener("exit",()=>{i||(i=!0,n("dismissed"))},!0)}),oe=(e,t)=>new Promise(n=>{const o=R({runtimeGame:e.getGame(),gameId:t});let i=!1;m=I=>{U({runtimeScene:e,event:I,checkOrigin:!0,onDone:F=>{i||(i=!0,n(F))}})},window.addEventListener("message",m,!0);const s=screen.width/2-500/2,h=screen.height/2-600/2,k=`left=${s},top=${h},width=500,height=600`,f=()=>{W=window.open(o,"authentication",k)};f(),p&&l.addAuthenticationUrlToTextsContainer(f,p)}),ie=(e,t)=>new Promise(n=>{if(!j||!y||!p){console.error("Can't open an authentication iframe - no iframe container, loader container or text container was opened for it.");return}const o=R({runtimeGame:e.getGame(),gameId:t});m=i=>{U({runtimeScene:e,event:i,checkOrigin:!0,onDone:n})},window.addEventListener("message",m,!0),l.displayIframeInsideAuthenticationContainer(j,y,p,o)});r.openAuthenticationWindow=e=>new c.PromiseTask(new Promise(t=>{const n=e.getGame().getRenderer().getDomElementContainer();if(!n){w(e,"The div element covering the game couldn't be found, the authentication window cannot be displayed."),t({status:"errored"});return}const o=c.projectData.properties.projectUuid;if(!o){w(e,"The game ID is missing, the authentication window cannot be opened."),t({status:"errored"});return}let i=!1;const s=()=>{G(e),r.displayAuthenticationBanner(e),i=!0,t({status:"dismissed"})};d&&(d.style.opacity="0");const h=$(e),{rootContainer:k,loaderContainer:f,iframeContainer:I}=l.computeAuthenticationContainer(s);T=k,y=f,j=I,n.appendChild(T),(async()=>{const F=await N(e.getGame(),o);if(y){const z=e.getGame().getRenderer().getElectron(),se=z?()=>z.shell.openExternal("https://wiki.gdevelop.io/gdevelop5/publishing/web"):null;p=l.addAuthenticationTextsToLoadingContainer(y,h,F,se)}if(!F)return;X(e);let C;switch(h){case"electron":C=await ee(e,o);break;case"cordova":C=await ne(e,o);break;case"cordova-websocket":C=await te(e,o);break;case"web-iframe":C=await ie(e,o);break;case"web":default:C=await oe(e,o);break}i||(C==="dismissed"&&s(),t({status:C}))})()})),r.isAuthenticationWindowOpen=function(){return!!T},r.removeAuthenticationContainer=function(e){L();const t=e.getGame().getRenderer().getDomElementContainer();if(!t){a.info("The div element covering the game couldn't be found, the authentication must be already closed.");return}T&&t.removeChild(T),T=null,y=null,j=null,p=null};const L=function(){m&&(window.removeEventListener("message",m,!0),m=null)};r.removeAuthenticationBanner=function(e){if(!d){a.info("The authentication banner couldn't be found, the authentication banner must be already closed.");return}const t=e.getGame().getRenderer().getDomElementContainer();if(!t){a.info("The div element covering the game couldn't be found, the authentication must be already closed.");return}t.removeChild(d),d=null};const x=function(e){const t=e.getGame().getRenderer().getCanvas();t&&t.focus()}})(Q=c.playerAuthentication||(c.playerAuthentication={}))})(gdjs||(gdjs={}));
//# sourceMappingURL=playerauthenticationtools.js.map
